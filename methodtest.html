<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/method.css" />
    <title>Part 1 of HW5 CSE134B</title>
</head>
<header>
    <nav>
        <a href="index.html">index</a>
        <a href="webcomponent.html">Button count</a>
        <a href="extracredit.html">Extra credit with React</a>
        <a href="extracredit2.html">Extra credit with VueJS</a>
    </nav>
</header>
<body>
    <h1 id="contact">Article</h1>
      <section>
        <form>
          <fieldset>
            <legend>Article form :</legend>
            <label for="record_id">Record ID:</label>
            <input type="number" id="record_id" name="record_id" /><br /><br />

            <label for="article_name">Article Name:</label>
		    <input type="text" id="article_name" name="article_name"><br><br>
		
		    <label for="article_body">Article Body:</label>
		    <textarea id="article_body" name="article_body"></textarea><br><br>
		
		    <label for="date">Date:</label>
		    <input type="text" id="date" name="date" readonly><br><br>
          </fieldset>

          <br>
		<fieldset>
			<legend>Select API:</legend>
			<label><input type="radio" name="api" value="xmlhttprequest" checked>XMLHttpRequest</label>
			<label><input type="radio" name="api" value="fetch">Fetch</label>
		</fieldset>
		<br>
        </form>

        <button id="postBtn" onclick="postData()">POST</button>
	    <button id="getBtn" onclick="getData()">GET</button>
	    <button id="putBtn" onclick="putData()">PUT</button>
	    <button id="deleteBtn" onclick="deleteData()">DELETE</button>

        <br>
        <output id="response"></output>


        <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.1/dist/purify.min.js"></script>
        <script> //use a module
            // date which should be the current date and time of the post generated by a JavaScript call to new Date()
            document.getElementById("date").value = new Date().toLocaleString();

            function postData() {

			let record_id = DOMPurify.sanitize(document.getElementById("record_id").value);
			let article_name = DOMPurify.sanitize(document.getElementById("article_name").value);
			let article_body = DOMPurify.sanitize(document.getElementById("article_body").value);
			let date = new Date().toLocaleString();
			
			// Build request body
			let requestBody = {
				"record_id": record_id,
				"article_name": article_name,
				"article_body": article_body,
				"date": date
			};
			
            let selectedApi = document.querySelector('input[name="api"]:checked').value;

            if (selectedApi === "xmlhttprequest") {
                // Send POST request using XMLHttpRequest
                let xhr = new XMLHttpRequest();
                xhr.responseType = '';
                xhr.open("POST", "https://httpbin.org/post");
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && this.status == 200) {
                        json = JSON.parse(xhr.responseText);
                        console.log(json);
                        const jsonString = JSON.stringify(json);
                        const outputEl = document.getElementById("response");
                        outputEl.innerHTML='';
                        outputEl.appendChild(stringToTable(jsonString));
                    }
                };
                xhr.send(JSON.stringify(requestBody));
            } else {
                fetch('https://httpbin.org/post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => response.json())
                .then(data => {
                        console.log(data);
                        const jsonString = JSON.stringify(data);
                        const outputEl = document.getElementById("response");
                        outputEl.innerHTML='';
                        outputEl.appendChild(stringToTable(jsonString));
                    })
                .catch(error => console.error(error));
            }
        }
		
            function getData() {
                let selectedApi = document.querySelector('input[name="api"]:checked').value;

                if (selectedApi === "xmlhttprequest") {

                    let xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            json = JSON.parse(xhr.responseText);
                            console.log(json);
                            const jsonString = JSON.stringify(json);
                            const outputEl = document.getElementById("response");
                            outputEl.innerHTML='';
                            outputEl.appendChild(stringToTable(jsonString));
                        }
                    };
                    xhr.open("GET", "https://httpbin.org/get");
                    xhr.setRequestHeader("Content-Type", "application/json");
                    xhr.send();

                } else {
                    fetch('https://httpbin.org/get')
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        const jsonString = JSON.stringify(data);
                        const outputEl = document.getElementById("response");
                        outputEl.innerHTML='';
                        outputEl.appendChild(stringToTable(jsonString));
                    })
                    .catch(error => console.error(error));
                }
                
            }
            
            function putData() {
                let record_id = DOMPurify.sanitize(document.getElementById("record_id").value);
                let article_name = DOMPurify.sanitize(document.getElementById("article_name").value);
                let article_body = DOMPurify.sanitize(document.getElementById("article_body").value);
                let date = new Date().toLocaleString();
                
                let requestBody = {
                    "record_id": record_id,
                    "article_name": article_name,
                    "article_body": article_body,
                    "date": date
                };
                
                let selectedApi = document.querySelector('input[name="api"]:checked').value;

                if (selectedApi === "xmlhttprequest") {
                    let xhr = new XMLHttpRequest();
                    xhr.open("PUT", "https://httpbin.org/put");
                    xhr.setRequestHeader("Content-Type", "application/json");
                    let requestBodyJson = JSON.stringify(requestBody);
                    xhr.send(requestBodyJson);
                    xhr.onload = function() {
                        if (xhr.status == 200 ) {
                            json = JSON.parse(xhr.responseText);
                            console.log(json);
                            const jsonString = JSON.stringify(json);
                            const outputEl = document.getElementById("response");
                            outputEl.innerHTML='';
                            outputEl.appendChild(stringToTable(jsonString));
                        } else {
                        console.error(xhr.statusText);
                        }
                    };
                    xhr.onerror = function() {
                        console.error("Request failed");
                    };
                    
                    
                } else {
                    fetch('https://httpbin.org/put', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        const jsonString = JSON.stringify(data);
                        const outputEl = document.getElementById("response");
                        outputEl.innerHTML='';
                        outputEl.appendChild(stringToTable(jsonString));
                    })
                    .catch(error => console.error(error));
                }
            }
            
            function deleteData() {
                
                let selectedApi = document.querySelector('input[name="api"]:checked').value;

                if (selectedApi === "xmlhttprequest") {
                    let xhr = new XMLHttpRequest();
                    xhr.open('DELETE', 'https://httpbin.org/delete');
                    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
                    xhr.onload = function () {
                        if (xhr.status === 200) {
                            json = JSON.parse(xhr.responseText);
                            console.log(json);
                            const jsonString = JSON.stringify(json);
                            const outputEl = document.getElementById("response");
                            outputEl.innerHTML='';
                            outputEl.appendChild(stringToTable(jsonString));
                        } else {
                            console.error('Error deleting data');
                        }
                    };
                    xhr.send();
                }else{
                    fetch('https://httpbin.org/delete', {
                    method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        const jsonString = JSON.stringify(data);
                        const outputEl = document.getElementById("response");
                        outputEl.innerHTML='';
                        outputEl.appendChild(stringToTable(jsonString));
                    })
                    .catch(error => console.error(error));

                    
                }
            }

            function stringToTable(json) {
                let data = JSON.parse(json);
                let table = document.createElement("table");
                for (const [key, value] of Object.entries(data)) {
                    const row = table.insertRow();
                    const keyCell = row.insertCell();
                    const valueCell = row.insertCell();

                    keyCell.textContent = key;

                    if (key === 'headers') {
                        const headersTable = document.createElement('table');
                        const headersRow = headersTable.insertRow();

                        // Add header names to the first row of the headers table
                        for (const headerName of Object.keys(value)) {
                            const headersCell = headersRow.insertCell();
                            headersCell.textContent = headerName;
                        }

                        // Add header values to subsequent rows of the headers table
                        const headersValuesRow = headersTable.insertRow();

                        for (const headerValue of Object.values(value)) {
                            const headersValuesCell = headersValuesRow.insertCell();
                            headersValuesCell.textContent = JSON.stringify(headerValue).replace(/\s*"/g,'');
                        }

                        // Add the headers table to the main table cell
                        valueCell.appendChild(headersTable);
                    } else {
                        valueCell.textContent = JSON.stringify(value).replace(/\s*"/g,' ');
                    }
                }

                const container = document.createElement('div');
                container.appendChild(table);
                return container;
                }

        </script>
    
</body>
</html>